<!DOCTYPE html>
<html>
<head>
  <title>Building Rule Upload Test</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    .rule { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
    .rule-header { display: flex; justify-content: space-between; }
    #response { margin-top: 20px; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; display: none; }
    .success { background: #e8f5e9; }
    .error { background: #ffebee; }
  </style>
</head>
<body>
  <h1>Building Rule Upload Test</h1>
  
  <div class="form-group">
    <label for="token">Authentication Token:</label>
    <input type="text" id="token" placeholder="Enter your JWT token" />
  </div>

  <form id="uploadForm" enctype="multipart/form-data">
    <div class="form-group">
      <label for="cityName">City Name:</label>
      <input type="text" id="cityName" name="cityName" required value="TestCity" />
    </div>
    
    <div class="form-group">
      <label for="pincode">Pincode:</label>
      <input type="text" id="pincode" name="pincode" required value="123456" />
    </div>
    
    <div class="form-group">
      <label for="documentFile">Building Rules Document (PDF/Text):</label>
      <input type="file" id="documentFile" name="documentFile" accept=".pdf,.txt,.doc,.docx" />
    </div>
    
    <div class="form-group">
      <label>Building Rules:</label>
      <div id="rulesList">
        <!-- Rules will be added here -->
      </div>
      <button type="button" id="addRule">Add Rule</button>
    </div>
    
    <button type="submit">Upload Building Rules</button>
  </form>
  
  <div id="response"></div>
  
  <script>
    // Template for a new rule
    function createRuleTemplate(index) {
      return `
        <div class="rule" data-index="${index}">
          <div class="rule-header">
            <h3>Rule #${index + 1}</h3>
            <button type="button" class="remove-rule">Remove</button>
          </div>
          
          <div class="form-group">
            <label>Room Type:</label>
            <select name="rules[${index}][roomType]" required>
              <option value="bedroom">Bedroom</option>
              <option value="kitchen">Kitchen</option>
              <option value="hall">Hall</option>
              <option value="bathroom">Bathroom</option>
              <option value="balcony">Balcony</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Description:</label>
            <input type="text" name="rules[${index}][description]" placeholder="Rule description" required />
          </div>
          
          <div class="form-group">
            <label>Min Length (meters):</label>
            <input type="number" name="rules[${index}][dimensions][minLength]" min="0" step="0.01" required value="3" />
          </div>
          
          <div class="form-group">
            <label>Min Width (meters):</label>
            <input type="number" name="rules[${index}][dimensions][minWidth]" min="0" step="0.01" required value="2.5" />
          </div>
          
          <div class="form-group">
            <label>Min Area (square meters):</label>
            <input type="number" name="rules[${index}][dimensions][minArea]" min="0" step="0.01" required value="7.5" />
          </div>
          
          <div class="form-group">
            <label>Max Length (meters, optional):</label>
            <input type="number" name="rules[${index}][dimensions][maxLength]" min="0" step="0.01" value="10" />
          </div>
          
          <div class="form-group">
            <label>Max Width (meters, optional):</label>
            <input type="number" name="rules[${index}][dimensions][maxWidth]" min="0" step="0.01" value="8" />
          </div>
          
          <div class="form-group">
            <label>Max Area (square meters, optional):</label>
            <input type="number" name="rules[${index}][dimensions][maxArea]" min="0" step="0.01" value="80" />
          </div>
          
          <div class="form-group">
            <label>Additional Requirements:</label>
            <textarea name="rules[${index}][additionalRequirements]" rows="2"></textarea>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="rules[${index}][isRequired]" checked />
              Is Required
            </label>
          </div>
          
          <input type="hidden" name="rules[${index}][sequence]" value="${index + 1}" />
        </div>
      `;
    }
    
    // Add a new rule to the form
    let ruleCount = 0;
    document.getElementById('addRule').addEventListener('click', () => {
      const rulesList = document.getElementById('rulesList');
      rulesList.insertAdjacentHTML('beforeend', createRuleTemplate(ruleCount));
      ruleCount++;
      
      // Add event listeners to new remove buttons
      document.querySelectorAll('.remove-rule').forEach(button => {
        button.onclick = function() {
          this.closest('.rule').remove();
          updateRuleIndexes();
        };
      });
    });
    
    // Update rule sequence numbers after removal
    function updateRuleIndexes() {
      const rules = document.querySelectorAll('.rule');
      rules.forEach((rule, index) => {
        rule.dataset.index = index;
        rule.querySelector('h3').textContent = `Rule #${index + 1}`;
        rule.querySelector('input[name*="[sequence]"]').value = index + 1;
      });
    }
    
    // Add initial rule
    document.getElementById('addRule').click();
    
    // Handle form submission
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData();
      
      // Add form fields to FormData
      formData.append('cityName', document.getElementById('cityName').value);
      formData.append('pincode', document.getElementById('pincode').value);
      
      // Add file if present
      const fileInput = document.getElementById('documentFile');
      if (fileInput.files.length > 0) {
        formData.append('documentFile', fileInput.files[0]);
      }
      
      // Collect rules from the form
      const rules = [];
      document.querySelectorAll('.rule').forEach((ruleElem, index) => {
        const rule = {
          sequence: index + 1,
          roomType: ruleElem.querySelector('select[name*="[roomType]"]').value,
          description: ruleElem.querySelector('input[name*="[description]"]').value,
          dimensions: {
            minLength: parseFloat(ruleElem.querySelector('input[name*="[dimensions][minLength]"]').value),
            minWidth: parseFloat(ruleElem.querySelector('input[name*="[dimensions][minWidth]"]').value),
            minArea: parseFloat(ruleElem.querySelector('input[name*="[dimensions][minArea]"]').value),
            unit: 'meters'
          },
          isRequired: ruleElem.querySelector('input[name*="[isRequired]"]').checked
        };
        
        // Add optional fields if they have values
        const maxLength = ruleElem.querySelector('input[name*="[dimensions][maxLength]"]').value;
        if (maxLength) rule.dimensions.maxLength = parseFloat(maxLength);
        
        const maxWidth = ruleElem.querySelector('input[name*="[dimensions][maxWidth]"]').value;
        if (maxWidth) rule.dimensions.maxWidth = parseFloat(maxWidth);
        
        const maxArea = ruleElem.querySelector('input[name*="[dimensions][maxArea]"]').value;
        if (maxArea) rule.dimensions.maxArea = parseFloat(maxArea);
        
        const additionalRequirements = ruleElem.querySelector('textarea[name*="[additionalRequirements]"]').value;
        if (additionalRequirements) rule.additionalRequirements = additionalRequirements;
        
        rules.push(rule);
      });
      
      // Add rules as JSON string to FormData
      formData.append('rules', JSON.stringify(rules));
      
      const responseDiv = document.getElementById('response');
      responseDiv.style.display = 'block';
      responseDiv.innerHTML = 'Uploading...';
      
      // Get token
      const token = document.getElementById('token').value;
      if (!token) {
        responseDiv.className = 'error';
        responseDiv.innerHTML = '<h3>Error</h3><p>Authentication token is required</p>';
        return;
      }
      
      try {
        const response = await fetch('http://localhost:8081/api/simple-building-rules', {
          method: 'POST',
          body: formData,
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          responseDiv.className = 'success';
          responseDiv.innerHTML = '<h3>Upload Successful!</h3><pre>' + JSON.stringify(result, null, 2) + '</pre>';
        } else {
          responseDiv.className = 'error';
          responseDiv.innerHTML = '<h3>Upload Failed</h3><pre>' + JSON.stringify(result, null, 2) + '</pre>';
        }
      } catch (error) {
        responseDiv.className = 'error';
        responseDiv.innerHTML = '<h3>Error</h3><p>' + error.message + '</p>';
      }
    });
  </script>
</body>
</html> 